<% display_w = local_assigns[:display_width] || 560 %>
<% scale = display_w.to_f / 560.0 %>
<% data = scaled_layout(@template, display_width: display_w) %>

<% display_width  = data[:display_width] %>
<% display_height = data[:display_height] %>
<% background     = data[:background] %>
<% placeholders   = data[:placeholders_scaled] %>

<div class="w-full overflow-hidden border-2 border-gray-200 bg-stone-50 rounded-md p-3 sm:p-4">
  <div
    class="mx-auto relative rounded-md overflow-hidden bg-stone-100"
    style="width:<%= display_width %>px; height:<%= display_height %>px;"
    data-text-style-scale-value="<%= scale %>"
  >
    <!-- 背景画像 -->
    <% if background["src"].present? %>
      <%= image_tag background["src"],
                    class: "absolute inset-0 w-full h-full object-contain pointer-events-none",
                    alt: @template.title %>
    <% end %>

    <!-- 行ガイド ＋ textarea（スケール適用済み） -->
    <% placeholders.each do |ph| %>
      <% next unless ph["kind"] == "text" %>

      <% line_id   = ph["id"] %>
      <% max_chars = ph.dig("constraints", "max_chars") %>

      <!-- ★ ここから変更：ガイド枠だけの div → textarea を内包する絶対配置コンテナに変更 -->
      <div
        class="absolute"
        style="
          left:<%= ph["x_scaled"] %>px;
          top:<%= ph["y_scaled"] %>px;
          width:<%= ph["width_scaled"] %>px;
          height:<%= ph["height_scaled"] %>px;
        "
      >
        <%= text_area_tag(
              "letter[placeholders][#{line_id}][value]",  # ★ name で line_id と紐づけ
              nil,                                        # ★ 既存値は issue13 で対応
              id: "letter_placeholders_#{line_id}_value",
              rows: 1,
              maxlength: max_chars,

              data: {
                action: "focus->text-style#select click->text-style#select",
                "text-style-target": "line",
                line_id: line_id,

                default_font_family: ph["font_family"],
                default_font_size: ph["font_size"],
                default_color: ph["color"]
              },
              class: "w-full h-full
                      border-0 border-b
                      bg-transparent
                      text-base text-stone-900
                      resize-none overflow-hidden
                      focus:outline-none focus:ring-2 focus:ring-sky-400 focus:border-sky-400",
              style: "box-sizing: border-box;
                      border-bottom-color: #000000;
                      padding: 0 4px;
                      line-height: 1.1;
                      font-family: #{ph["font_family"] || "Noto Sans JP"};
                      font-size: #{(ph["font_size"] || 16).to_i}px;
                      color: #{ph["color"] || "#000000"};"
            ) %>
        <%= hidden_field_tag "letter[placeholders][#{line_id}][overrides][font_family]", "",
            data: { "text-style-target": "hiddenFontFamily", line_id: line_id } %>

        <%= hidden_field_tag "letter[placeholders][#{line_id}][overrides][font_size]", "",
            data: { "text-style-target": "hiddenFontSize", line_id: line_id } %>

        <%= hidden_field_tag "letter[placeholders][#{line_id}][overrides][color]", "",
            data: { "text-style-target": "hiddenColor", line_id: line_id } %>
      </div>
    <% end %>
  </div>
</div>